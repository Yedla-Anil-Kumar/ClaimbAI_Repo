# Azure ML SDK v2 + CLI v2 YAML + Managed Endpoint + Registry reuse

from azure.ai.ml import MLClient, Input, command
from azure.identity import DefaultAzureCredential
from azure.ai.ml.dsl import pipeline
from azure.ai.ml.entities import ManagedOnlineEndpoint, ManagedOnlineDeployment

cred = DefaultAzureCredential()
ml_client = MLClient(cred, subscription_id="xxxx", resource_group="rg-ml", workspace="ws-ml")

# Job via SDK
train_job = command(
    code="./src",
    command="python train.py --epochs 10",
    environment="azureml://registries/azureml/environments/sklearn-1.3/versions/5",
    inputs={"train": Input(path="azureml:train_data@latest")}
)

# Pipeline DSL
@pipeline()
def credit_pipe():
    return train_job

pipe_job = credit_pipe()
ml_client.jobs.create_or_update(pipe_job)

# Managed endpoint via Python
ep = ManagedOnlineEndpoint(name="credit-risk", auth_mode="key")
dp = ManagedOnlineDeployment(
    name="blue",
    endpoint_name=ep.name,
    model="azureml:credit_risk_model@latest",
    instance_type="Standard_DS3_v2",
    instance_count=1
)

# YAML (CLI v2) example: endpoints/online/endpoint.yaml, deployment.yaml
# az ml online-endpoint create -f endpoint.yaml
# az ml online-deployment create -f deployment.yaml --all-traffic

# Registry reuse above in environment/model references
# ADO pipeline triggers jobs + deploy on main branch
